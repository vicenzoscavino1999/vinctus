name: CI

on:
  pull_request:
  push:
    branches: [main]

env:
  VITE_FIREBASE_API_KEY: test
  VITE_FIREBASE_AUTH_DOMAIN: localhost
  VITE_FIREBASE_PROJECT_ID: vinctus-dev
  VITE_FIREBASE_STORAGE_BUCKET: vinctus-dev.appspot.com
  VITE_FIREBASE_MESSAGING_SENDER_ID: test
  VITE_FIREBASE_APP_ID: test
  VITE_USE_FIREBASE_EMULATOR: true
  VITE_FIREBASE_EMULATOR_HOST: 127.0.0.1
  FIREBASE_PROJECT_ID: vinctus-dev
  GCLOUD_PROJECT: vinctus-dev

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm run guardrails

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm run typecheck

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm install --no-save @rollup/rollup-linux-x64-gnu@4.55.1
      - run: npm run test:run

  rules:
    name: rules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm install --no-save @rollup/rollup-linux-x64-gnu@4.55.1
      - run: npm run test:rules

  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm install --no-save @rollup/rollup-linux-x64-gnu@4.55.1
      - run: npm run build

  e2e:
    name: e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci --include=optional
      - run: npm install --no-save @rollup/rollup-linux-x64-gnu@4.55.1
      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
      - run: npm run functions:install
        if: github.event_name != 'pull_request'
      - run: npm run functions:build
        if: github.event_name != 'pull_request'
      - run: npx playwright install --with-deps chromium
      - run: npx firebase emulators:exec --only auth,firestore,storage --project vinctus-dev "npm run seed && PLAYWRIGHT_SMOKE_FAST=1 npm run test:e2e:smoke"
        if: github.event_name == 'pull_request'
      - run: npx firebase emulators:exec --only auth,firestore,storage,functions --project vinctus-dev "npm run seed && npm run test:e2e"
        if: github.event_name != 'pull_request'
